<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Persistent Color Selector</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      height: 100vh;
    }
    #content {
      max-width: 800px;
      text-align: justify;
      user-select: none; /* Disable default selection */
    }
    .color-setting {
      margin: 10px 0;
      display: flex;
      align-items: center;
    }
    .color-setting label {
      margin-right: 10px;
    }
    input[type="color"], input[type="text"], button {
      margin: 0 5px;
    }
    input[type="text"] {
      width: 80px;
      text-align: center;
    }
    .highlighted {
      color: #ff0000;
    }
  </style>
</head>
<body>
  <h1>Persistent Color Selector</h1>
  <div class="color-setting">
    <label for="bgColor">Background Color:</label>
    <input type="color" id="bgColorPicker">
    <input type="text" id="bgColorHex">
  </div>
  <div class="color-setting">
    <label for="textColor">Paragraph Color:</label>
    <input type="color" id="textColorPicker">
    <input type="text" id="textColorHex">
    <button id="applyParagraphColor">Set Paragraph Color</button>
  </div>
  <div class="color-setting">
    <label for="highlightColor">Highlight Part Color:</label>
    <input type="color" id="highlightColorPicker">
    <input type="text" id="highlightColorHex">
    <button id="applyHighlight">Highlight Part</button>
    <button id="resetHighlights">Reset</button>
  </div>
  <div id="content">
    <p id="paragraph">
      Once upon a time, in a small village nestled among rolling hills and vast forests, lived a young girl named Ella. She spent her days exploring the woods, listening to the whisper of leaves in the wind, and marveling at the beauty of nature. Her heart was filled with curiosity, and her dreams stretched beyond the horizon.
    </p>
  </div>

  <script>
    const bgColorPicker = document.getElementById('bgColorPicker');
    const bgColorHex = document.getElementById('bgColorHex');
    const textColorPicker = document.getElementById('textColorPicker');
    const textColorHex = document.getElementById('textColorHex');
    const highlightColorPicker = document.getElementById('highlightColorPicker');
    const highlightColorHex = document.getElementById('highlightColorHex');
    const applyParagraphColorButton = document.getElementById('applyParagraphColor');
    const applyHighlightButton = document.getElementById('applyHighlight');
    const resetHighlightsButton = document.getElementById('resetHighlights');
    const paragraph = document.getElementById('paragraph');

    const defaultParagraphContent = paragraph.innerHTML;

    let selectionStart = 0;
    let selectionEnd = 0;
    let isSelecting = false;

    // Save colors and highlighted text to localStorage
    function saveState() {
      localStorage.setItem('bgColor', bgColorPicker.value);
      localStorage.setItem('textColor', textColorPicker.value);
      localStorage.setItem('highlightColor', highlightColorPicker.value);
      localStorage.setItem('paragraphHTML', paragraph.innerHTML);
    }

    // Load colors and highlighted text from localStorage
    function loadState() {
      const bgColor = localStorage.getItem('bgColor') || '#ffffff';
      const textColor = localStorage.getItem('textColor') || '#000000';
      const highlightColor = localStorage.getItem('highlightColor') || '#ff0000';
      const savedParagraphHTML = localStorage.getItem('paragraphHTML') || defaultParagraphContent;

      // Apply saved settings
      document.body.style.backgroundColor = bgColor;
      bgColorPicker.value = bgColor;
      bgColorHex.value = bgColor;

      paragraph.style.color = textColor;
      textColorPicker.value = textColor;
      textColorHex.value = textColor;

      highlightColorPicker.value = highlightColor;
      highlightColorHex.value = highlightColor;

      paragraph.innerHTML = savedParagraphHTML;
    }

    // Sync picker and hex input for a given color
    function syncColorInput(picker, hexInput, applyFunction) {
      picker.addEventListener('input', () => {
        hexInput.value = picker.value;
        applyFunction(picker.value);
        saveState();
      });
      hexInput.addEventListener('input', () => {
        picker.value = hexInput.value;
        applyFunction(hexInput.value);
        saveState();
      });
    }

    // Apply background color
    syncColorInput(bgColorPicker, bgColorHex, (color) => {
      document.body.style.backgroundColor = color;
    });

    // Apply paragraph color
    syncColorInput(textColorPicker, textColorHex, (color) => {
      paragraph.style.color = color;
    });

    // Apply highlight color
    syncColorInput(highlightColorPicker, highlightColorHex, () => {});

    // Custom selection handling for touch devices
    paragraph.addEventListener('touchstart', (e) => {
      isSelecting = true;
      const touch = e.touches[0];
      const position = document.caretRangeFromPoint(touch.clientX, touch.clientY);
      if (position) {
        selectionStart = position.startOffset;
      }
      e.preventDefault();
    });

    paragraph.addEventListener('touchmove', (e) => {
      if (isSelecting) {
        const touch = e.touches[0];
        const position = document.caretRangeFromPoint(touch.clientX, touch.clientY);
        if (position) {
          selectionEnd = position.endOffset;
        }
      }
      e.preventDefault();
    });

    paragraph.addEventListener('touchend', () => {
      isSelecting = false;
      if (selectionStart !== selectionEnd) {
        applyHighlight(selectionStart, selectionEnd);
        saveState();
      }
    });

    // Apply highlight to selected text
    function applyHighlight(start, end) {
      const text = paragraph.textContent;
      const highlightedText = `<span style="color: ${highlightColorPicker.value}">${text.slice(start, end)}</span>`;
      const newHTML = text.slice(0, start) + highlightedText + text.slice(end);
      paragraph.innerHTML = newHTML;
    }

    // Highlight selected text button click handler for desktop
    applyHighlightButton.addEventListener('click', () => {
      const selection = window.getSelection();
      if (selection && selection.rangeCount > 0) {
        const range = selection.getRangeAt(0);
        const span = document.createElement('span');
        span.style.color = highlightColorPicker.value;
        span.textContent = range.toString();

        range.deleteContents();
        range.insertNode(span);

        saveState();

        // Clear the selection
        selection.removeAllRanges();
      } else {
        alert('Please select text to highlight!');
      }
    });

    // Reset all highlights
    resetHighlightsButton.addEventListener('click', () => {
      paragraph.innerHTML = defaultParagraphContent;
      saveState();
    });

    // Apply paragraph color when button is clicked
    applyParagraphColorButton.addEventListener('click', () => {
      paragraph.style.color = textColorPicker.value;
      saveState();
    });

    // Load state when the page loads
    loadState();
  </script>
</body>
</html>
