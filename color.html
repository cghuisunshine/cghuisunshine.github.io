<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Persistent Color Selector</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      height: 100vh;
      user-select: none; /* Disable native text selection */
    }
    #content {
      max-width: 800px;
      text-align: justify;
    }
    .color-setting {
      margin: 10px 0;
      display: flex;
      align-items: center;
    }
    .color-setting label {
      margin-right: 10px;
    }
    input[type="color"], input[type="text"], button {
      margin: 0 5px;
    }
    input[type="text"] {
      width: 80px;
      text-align: center;
    }
    span.highlight {
      background-color: yellow; /* Highlight color, can be dynamic based on picker */
    }
  </style>
</head>
<body>
  <h1>Persistent Color Selector</h1>
  <div class="color-setting">
    <label for="bgColor">Background Color:</label>
    <input type="color" id="bgColorPicker">
    <input type="text" id="bgColorHex">
  </div>
  <div class="color-setting">
    <label for="textColor">Paragraph Color:</label>
    <input type="color" id="textColorPicker">
    <input type="text" id="textColorHex">
    <button id="applyParagraphColor">Set Paragraph Color</button>
  </div>
  <div class="color-setting">
    <label for="highlightColor">Highlight Part Color:</label>
    <input type="color" id="highlightColorPicker">
    <input type="text" id="highlightColorHex">
    <button id="applyHighlight">Highlight Part</button>
    <button id="resetHighlights">Reset</button>
  </div>
  <div id="content">
    <p id="paragraph">
        Once upon a time, in a small village nestled among rolling hills and vast forests, lived a young girl named Ella. She spent her days exploring the woods, listening to the whisper of leaves in the wind, and marveling at the beauty of nature. Her heart was filled with curiosity, and her dreams stretched beyond the horizon.
    </p>
  </div>

  <script>
    const bgColorPicker = document.getElementById('bgColorPicker');
    const bgColorHex = document.getElementById('bgColorHex');
    const textColorPicker = document.getElementById('textColorPicker');
    const textColorHex = document.getElementById('textColorHex');
    const highlightColorPicker = document.getElementById('highlightColorPicker');
    const highlightColorHex = document.getElementById('highlightColorHex');
    const applyParagraphColorButton = document.getElementById('applyParagraphColor');
    const applyHighlightButton = document.getElementById('applyHighlight');
    const resetHighlightsButton = document.getElementById('resetHighlights');
    const paragraph = document.getElementById('paragraph');

    // Initial default content backup for reset functionality
    const defaultParagraphContent = paragraph.innerHTML;

    // Save colors and highlighted text to localStorage
    function saveState() {
      localStorage.setItem('bgColor', bgColorPicker.value);
      localStorage.setItem('textColor', textColorPicker.value);
      localStorage.setItem('highlightColor', highlightColorPicker.value);
      localStorage.setItem('paragraphHTML', paragraph.innerHTML);
    }

    // Load colors and highlighted text from localStorage
    function loadState() {
      const bgColor = localStorage.getItem('bgColor') || '#ffffff';
      const textColor = localStorage.getItem('textColor') || '#000000';
      const highlightColor = localStorage.getItem('highlightColor') || '#ff0000';
      const savedParagraphHTML = localStorage.getItem('paragraphHTML') || defaultParagraphContent;

      document.body.style.backgroundColor = bgColor;
      bgColorPicker.value = bgColor;
      bgColorHex.value = bgColor;

      paragraph.style.color = textColor;
      textColorPicker.value = textColor;
      textColorHex.value = textColor;

      highlightColorPicker.value = highlightColor;
      highlightColorHex.value = highlightColor;

      paragraph.innerHTML = savedParagraphHTML;
    }

    // Sync picker and hex input for a given color
    function syncColorInput(picker, hexInput, applyFunction) {
      picker.addEventListener('input', () => {
        hexInput.value = picker.value;
        applyFunction(picker.value);
        saveState();
      });
      hexInput.addEventListener('input', () => {
        picker.value = hexInput.value;
        applyFunction(hexInput.value);
        saveState();
      });
    }

    // Apply background color
    syncColorInput(bgColorPicker, bgColorHex, (color) => {
      document.body.style.backgroundColor = color;
    });

    // Apply paragraph color
    syncColorInput(textColorPicker, textColorHex, (color) => {
      paragraph.style.color = color;
    });

    // Custom touch-based text selection
    document.addEventListener('touchstart', handleTouchStart, false);
    document.addEventListener('touchmove', handleTouchMove, false);
    document.addEventListener('touchend', handleTouchEnd, false);

    let touchStartPos = null;
    let touchEndPos = null;

    function handleTouchStart(e) {
      touchStartPos = getTouchPosition(e.touches[0]);
    }

    function handleTouchMove(e) {
      touchEndPos = getTouchPosition(e.touches[0]);
    }

    function handleTouchEnd(e) {
      if (touchStartPos && touchEndPos) {
        highlightText(touchStartPos, touchEndPos);
      }
      touchStartPos = null;
      touchEndPos = null;
    }

    function getTouchPosition(touch) {
      const range = document.caretRangeFromPoint(touch.clientX, touch.clientY);
      return range ? range.startOffset : null;
    }

    function highlightText(start, end) {
      if (!start || !end) return;
      const range = new Range();
      range.setStart(paragraph.firstChild, start);
      range.setEnd(paragraph.firstChild, end);

      const selection = window.getSelection();
      selection.removeAllRanges();
      selection.addRange(range);

      const span = document.createElement('span');
      span.className = 'highlight';
      span.style.backgroundColor = highlightColorPicker.value;
      span.textContent = selection.toString();

      range.deleteContents();
      range.insertNode(span);
      saveState();
    }

    // Reset highlights
    resetHighlightsButton.addEventListener('click', () => {
      paragraph.innerHTML = defaultParagraphContent;
      saveState();
    });

    // Apply paragraph color when button is clicked
    applyParagraphColorButton.addEventListener('click', () => {
      paragraph.style.color = textColorPicker.value;
      saveState();
    });

    loadState();
  </script>
</body>
</html>
