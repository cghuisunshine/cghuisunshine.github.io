<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Refine or translate to native English</title>
  <style>
    /* make sizing predictable */
    *, *::before, *::after { box-sizing: border-box; }

    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 20px;
      line-height: 1.4;
    }

    /* center and constrain chat area */
    #chat-container {
      width: 100%;
      max-width: 600px;
      margin: auto;
      padding: 0 10px;
    }

    h1 {
      text-align: center;
      margin-bottom: 20px;
      font-size: 1.8rem;
    }

    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 10px;
    }
    .controls button {
      flex: 1 1 100px;
      padding: 10px;
      font-size: 1rem;
      cursor: pointer;
    }

    .message {
      margin: 10px 0;
      word-wrap: break-word;
    }
    .user { color: #0066cc; }
    .bot  { color: #228822; }

    pre {
      background: #f4f4f4;
      padding: 10px;
      border-radius: 5px;
      position: relative;
      overflow-x: auto;
    }

    code {
      font-family: monospace;
      color: #d6336c;
    }

    .copy-button {
      position: absolute;
      top: 5px;
      right: 5px;
      background: #007bff;
      color: white;
      border: none;
      padding: 5px;
      border-radius: 3px;
      font-size: 0.8rem;
      cursor: pointer;
    }

    textarea,
    input, select {
      width: 100%;
      margin-top: 5px;
      padding: 10px;
      font-size: 1rem;
      border: 1px solid #ccc;
      border-radius: 4px;
    }

    textarea {
      height: 100px;
      resize: vertical;
    }

    button {
      border: none;
      border-radius: 4px;
    }

    #apiKeyWrapper,
    #serviceSelectWrapper,
    #modelSelectWrapper {
      display: none; /* toggled by menu */
      margin-bottom: 15px;
    }

    #hamburgerMenu {
      font-size: 1.5rem;
      cursor: pointer;
      margin-bottom: 10px;
    }

    @media (max-width: 400px) {
      .controls { flex-direction: column; }
      .controls button { width: 100%; }
    }
  </style>
</head>
<body>
  <div id="chat-container">

    <div id="hamburgerMenu" role="button" tabindex="0" aria-label="Toggle menu">☰</div>

    <div id="apiKeyWrapper">
      <label for="apiKey">API Key:</label>
      <input type="password" id="apiKey" placeholder="Enter your API key"/>
      <button id="saveApiKeyButton">Save Key</button>
    </div>

    <div id="serviceSelectWrapper">
      <label for="serviceSelect">Service:</label>
      <select id="serviceSelect">
        <option value="openai">OpenAI</option>
        <option value="deepseek">DeepSeek</option>
        <option value="grok" selected>Grok</option>
      </select>
    </div>

    <div id="modelSelectWrapper">
      <label for="modelSelect">Model:</label>
      <select id="modelSelect"></select>
    </div>

    <div id="chat">
      <textarea id="userMessage" placeholder="Type your message...it would be refined or translated to natvie English"></textarea>
      <div class="controls">
        <button id="sendMessageButton">Send</button>
        <button id="clearChatButton">Clear</button>
        <button id="copyLastButton">Copy Reply</button>
      </div>
      <div id="chatMessages"></div>

    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const hamburger      = document.getElementById('hamburgerMenu');
      const apiKeyWrapper  = document.getElementById('apiKeyWrapper');
      const serviceWrapper = document.getElementById('serviceSelectWrapper');
      const modelWrapper   = document.getElementById('modelSelectWrapper');
      const saveKeyBtn     = document.getElementById('saveApiKeyButton');
      const serviceSelect  = document.getElementById('serviceSelect');
      const modelSelect    = document.getElementById('modelSelect');
      const sendBtn        = document.getElementById('sendMessageButton');
      const clearBtn       = document.getElementById('clearChatButton');
      const copyBtn        = document.getElementById('copyLastButton');
      const chatMessages   = document.getElementById('chatMessages');
      const userArea       = document.getElementById('userMessage');
      const apiKeyLabel    = document.querySelector("label[for='apiKey']");

      const serviceDisplay = {
        openai:   'OpenAI',
        deepseek: 'DeepSeek',
        grok:     'Grok'
      };
      const serviceEndpoint = {
        openai:   'https://api.openai.com/v1/chat/completions',
        deepseek: 'https://api.deepseek.com/v1/chat/completions',
        grok:     'https://api.x.ai/v1/chat/completions'
      };
      const modelOptions = {
        openai:   [ {value:'gpt-4o-mini', label:'gpt-4o-mini'} ],
        deepseek: [ {value:'deepseek-chat',label:'DeepSeek Chat'},{value:'deepseek-reasoner',label:'DeepSeek Reasoner'} ],
        grok:     [ {value:'grok-3',       label:'grok-3'} ]
      };

      // system prompt & conversation history
      const systemPrompt = `Task: Review the input text. If it is not in English, translate it into clear, idiomatic, native-level English, preserving the original meaning, tone, and any important formatting. If it is already in English, refine it so it reads as if written by an educated native speaker—correct grammar, improve word choice, and enhance flow and clarity—while keeping the author’s intended meaning and style intact. Output only the improved English text, with no added explanations or notes.`;
      const MAX_PAIRS = 10;
      const MAX_MESSAGES = 1 + MAX_PAIRS * 2;
      const conversation = [{ role: 'system', content: systemPrompt }];

      // toggle menu
      hamburger.addEventListener('click', () => {
        const show = apiKeyWrapper.style.display !== 'block';
        apiKeyWrapper.style.display    = show ? 'block' : 'none';
        serviceWrapper.style.display   = show ? 'block' : 'none';
        modelWrapper.style.display     = show ? 'block' : 'none';
      });

      // populate models
      function refreshModels() {
        const svc = serviceSelect.value;
        modelSelect.innerHTML = '';
        modelOptions[svc].forEach(opt => {
          const o = document.createElement('option');
          o.value = opt.value;
          o.textContent = opt.label;
          modelSelect.append(o);
        });
      }
      serviceSelect.addEventListener('change', () => {
        refreshModels();
        apiKeyLabel.textContent = serviceDisplay[serviceSelect.value] + ' API Key:';
      });

      // initial setup
      refreshModels();
      apiKeyLabel.textContent = serviceDisplay[serviceSelect.value] + ' API Key:';

      // save key
      saveKeyBtn.addEventListener('click', () => {
        const key = document.getElementById('apiKey').value.trim();
        const svc = serviceSelect.value;
        if (!key) return alert('Please enter a valid key.');
        localStorage.setItem(`${svc}_api_key`, key);
        alert(`${serviceDisplay[svc]} key saved!`);
        document.getElementById('apiKey').value = '';
      });

      // format bot messages
      function formatMessage(msg) {
        const div = document.createElement('div');
        div.innerHTML = marked.parse(msg, { gfm:true, breaks:true });
        div.querySelectorAll('pre code').forEach(cb => {
          const btn = document.createElement('button');
          btn.className = 'copy-button';
          btn.textContent = 'Copy Code';
          btn.onclick = () => navigator.clipboard.writeText(cb.textContent).then(() => alert('Copied!'));
          cb.parentElement.style.position = 'relative';
          cb.parentElement.appendChild(btn);
        });
        return div.innerHTML;
      }

      // clear chat
      clearBtn.onclick = () => {
        chatMessages.innerHTML = '';
        conversation.splice(1);
      };

      // copy last reply
      copyBtn.onclick = () => {
        const bots = chatMessages.querySelectorAll('.message.bot');
        if (!bots.length) return alert('No reply to copy.');
        const text = bots[bots.length - 1].innerText.replace(/^[^:]+:\s*/,'');
        navigator.clipboard.writeText(text).then(() => alert('Last reply copied!'));
      };

      // handle Cmd+Enter / Ctrl+Enter
      userArea.addEventListener('keydown', e => {
        if (e.key === 'Enter' && (e.metaKey || e.ctrlKey)) {
          e.preventDefault();
          sendBtn.click();
        }
      });

      // send
      sendBtn.onclick = async () => {
        const svc = serviceSelect.value;
        const key = localStorage.getItem(`${svc}_api_key`);
        if (!key) return alert(`Set your ${serviceDisplay[svc]} key first.`);
        const userText = userArea.value.trim();
        if (!userText) return alert('Please type a message.');

        // add to context & UI
        conversation.push({ role: 'user', content: userText });
        chatMessages.innerHTML += `<div class="message user">You: ${userText}</div>`;
        userArea.value = '';

        try {
          const res = await fetch(serviceEndpoint[svc], {
            method: 'POST',
            headers: {
              'Authorization': `Bearer ${key}`,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              model: modelSelect.value,
              messages: conversation
            })
          });
          if (!res.ok) throw new Error(res.statusText);
          const data = await res.json();
          const reply = data.choices[0].message.content;

          // add assistant reply to context & UI
          conversation.push({ role: 'assistant', content: reply });
          if (conversation.length > MAX_MESSAGES) {
            conversation.splice(1, conversation.length - MAX_MESSAGES);
          }

          chatMessages.innerHTML +=
            `<div class="message bot">${serviceDisplay[svc]}: ${formatMessage(reply)}</div>`;
        } catch (e) {
          chatMessages.innerHTML += `<div class="message bot">Error: ${e.message}</div>`;
        }
      };
    });
  </script>
</body>
</html>

